<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Luckysheet in Flutter WebView</title>

    <!-- Luckysheet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/css/pluginsCss.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/plugins.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/css/luckysheet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/assets/iconfont/iconfont.css" />


    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #toolbar {
            height: 44px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            border-bottom: 1px solid #ddd;
        }

        #luckysheet {
            width: 100%;
            height: calc(100% - 45px);
        }

        button {
            height: 30px;
        }

        .hint {
            font-family: system-ui, -apple-system, Arial;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button onclick="exportJson()">Export JSON (to Flutter)</button>
        <button onclick="exportXlsxToFlutter()">Export XLSX (to Flutter)</button>
        <div class="hint">Import .xlsx gọi từ Flutter → window.importXlsxBase64(...)</div>
    </div>

    <div id="luckysheet"></div>

    <!-- Luckysheet JS -->
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/luckysheet.umd.js"></script>

    <!-- LuckyExcel (xlsx -> luckysheet json) -->
    <script src="https://cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>

    <!-- SheetJS (luckysheet data -> xlsx) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        function postToFlutter(obj) {
            try {
                if (window.Flutter && window.Flutter.postMessage) {
                    window.Flutter.postMessage(JSON.stringify(obj));
                }
            } catch (_) { }
        }

        function initBlank() {
            luckysheet.create({
                container: "luckysheet",
                title: "POC",
                lang: "en",
                data: [{ name: "Sheet1", index: 0, status: 1, order: 0, celldata: [] }]
            });
            postToFlutter({ type: "web_ready" });
        }

        // Called by Flutter: window.importXlsxBase64(base64, filename)
        window.importXlsxBase64 = function (b64, filename) {
            try {
                const binary = atob(b64);
                const len = binary.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);

                const blob = new Blob([bytes], {
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                });

                const file = new File([blob], filename || "import.xlsx");

                LuckyExcel.transformExcelToLucky(
                    file,
                    function (exportJson, luckysheetfile) {
                        try { luckysheet.destroy(); } catch (e) { }
                        luckysheet.create({
                            container: "luckysheet",
                            data: exportJson.sheets,
                            title: (exportJson.info && exportJson.info.name) ? exportJson.info.name : "Imported",
                        });

                        postToFlutter({ type: "import_ok", sheetCount: exportJson.sheets.length });
                    },
                    function (err) {
                        postToFlutter({ type: "import_err", err: String(err) });
                    }
                );
            } catch (e) {
                postToFlutter({ type: "import_err", err: String(e) });
            }
        };

        function exportJson() {
            try {
                const data = luckysheet.getAllSheets ? luckysheet.getAllSheets() : [];
                postToFlutter({ type: "export_json", data });
            } catch (e) {
                postToFlutter({ type: "export_err", err: String(e) });
            }
        }

        function cellToValue(cell) {
            if (cell == null) return null;
            if (typeof cell !== "object") return cell;
            // ưu tiên v (giá trị), fallback m (hiển thị)
            if (cell.v !== undefined && cell.v !== null) return cell.v;
            if (cell.m !== undefined && cell.m !== null) return cell.m;
            return null;
        }

        function sheetDataToAoa(sheetData) {
            const aoa = [];
            for (let r = 0; r < sheetData.length; r++) {
                const row = sheetData[r] || [];
                const outRow = [];
                for (let c = 0; c < row.length; c++) {
                    outRow.push(cellToValue(row[c]));
                }
                aoa.push(outRow);
            }
            return aoa;
        }

        // Export XLSX (data-only) -> base64 -> Flutter
        function exportXlsxToFlutter() {
            try {
                // cố gắng commit ô đang edit
                try { luckysheet.exitEditMode && luckysheet.exitEditMode(); } catch (_) { }

                const sheets = luckysheet.getAllSheets ? luckysheet.getAllSheets() : [];
                if (!sheets.length) {
                    postToFlutter({ type: "export_err", err: "No sheets found." });
                    return;
                }

                const wb = XLSX.utils.book_new();

                for (const sh of sheets) {
                    const order = Number(sh.order ?? 0);
                    const name = (sh.name || `Sheet${order + 1}`).toString().slice(0, 31);

                    // Official API: getSheetData({order}) returns luckysheetfile[i].data :contentReference[oaicite:2]{index=2}
                    let data2d = [];
                    if (luckysheet.getSheetData) {
                        data2d = luckysheet.getSheetData({ order }) || [];
                    } else if (sh.data) {
                        data2d = sh.data;
                    } else {
                        data2d = [];
                    }

                    const aoa = sheetDataToAoa(data2d);
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    XLSX.utils.book_append_sheet(wb, ws, name);
                }

                const b64 = XLSX.write(wb, { bookType: "xlsx", type: "base64" });
                postToFlutter({ type: "export_xlsx", fileName: "edited.xlsx", b64 });
            } catch (e) {
                postToFlutter({ type: "export_err", err: String(e) });
            }
        }

        initBlank();
    </script>
</body>

</html>