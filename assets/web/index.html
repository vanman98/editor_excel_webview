<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Luckysheet in Flutter WebView</title>

    <!-- Luckysheet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/css/pluginsCss.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/plugins.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/css/luckysheet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/assets/iconfont/iconfont.css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #toolbar {
            height: 44px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px;
            border-bottom: 1px solid #ddd;
            font-family: system-ui, -apple-system, Arial;
        }

        #luckysheet {
            width: 100%;
            height: calc(100% - 45px);
        }

        button {
            height: 30px;
        }

        .hint {
            font-size: 12px;
            color: #666;
        }

        .pill {
            font-size: 12px;
            background: #f1f1f1;
            padding: 4px 8px;
            border-radius: 999px;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button onclick="exportChangesToFlutter()">Export Changes</button>
        <button onclick="clearChanges()">Clear Changes</button>

        <span class="pill" id="changeCount">changes=0</span>
        <span class="pill" id="sheetOpsCount">sheetOps=0</span>
        <div class="hint">Edit cell / change style / add sheet → Flutter receives events.</div>
    </div>

    <div id="luckysheet"></div>

    <!-- Luckysheet JS -->
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/plugins/js/plugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luckysheet@2.1.13/dist/luckysheet.umd.js"></script>

    <!-- LuckyExcel (xlsx -> luckysheet json) -->
    <script src="https://cdn.jsdelivr.net/npm/luckyexcel/dist/luckyexcel.umd.js"></script>

    <script>
        function postToFlutter(obj) {
            try {
                if (window.Flutter && window.Flutter.postMessage) {
                    window.Flutter.postMessage(JSON.stringify(obj));
                }
            } catch (_) { }
        }

        function setChangeCount(n) {
            const el = document.getElementById("changeCount");
            if (el) el.textContent = `changes=${n}`;
        }

        function setSheetOpsCount(n) {
            const el = document.getElementById("sheetOpsCount");
            if (el) el.textContent = `sheetOps=${n}`;
        }

        // ===== Change buffer (unique by sheetId+r+c) =====
        // key = `${sheetId}#${r}#${c}`
        const __changes = {};

        function excelColName(col0) {
            let n = col0 + 1;
            let s = "";
            while (n > 0) {
                const r = (n - 1) % 26;
                s = String.fromCharCode(65 + r) + s;
                n = Math.floor((n - 1) / 26);
            }
            return s;
        }

        function a1Address(r0, c0) {
            return excelColName(c0) + String(r0 + 1);
        }

        // ===== STYLE CAPTURE =====
        function pickStyle(cell) {
            if (!cell || typeof cell !== "object") return {};
            // các key style thường gặp trong luckysheet cell
            const keys = ["bg", "fc", "ff", "fs", "bl", "it", "ul", "cl", "ht", "vt", "tb", "tr", "ct", "bd"];
            const out = {};
            for (const k of keys) {
                if (cell[k] !== undefined && cell[k] !== null) out[k] = cell[k];
            }
            return out;
        }

        function normalizeCell(cell) {
            if (cell == null) return { value: null, formula: null, display: null, style: {} };
            if (typeof cell !== "object") {
                return { value: cell, formula: null, display: String(cell), style: {} };
            }

            const value = cell.v !== undefined ? cell.v : null;
            const display = cell.m !== undefined ? cell.m : value != null ? String(value) : null;

            // formula có thể "SUM(...)" hoặc "=SUM(...)" → normalize luôn có "="
            let formula = cell.f !== undefined && cell.f !== null ? String(cell.f) : null;
            if (formula && !formula.startsWith("=")) formula = "=" + formula;

            return { value, formula, display, style: pickStyle(cell) };
        }

        function getActiveSheetMeta() {
            try {
                if (luckysheet.getSheet) {
                    const s = luckysheet.getSheet();
                    if (s && s.name != null) {
                        const id = (s.index ?? s.id ?? s.name ?? s.order ?? 0).toString();
                        return { id, name: s.name, order: s.order ?? 0, index: s.index ?? 0 };
                    }
                }
            } catch (_) { }

            try {
                const all = luckysheet.getAllSheets ? luckysheet.getAllSheets() : [];
                const active = all.find((x) => x && x.status === 1) || all[0] || { name: "Sheet1", order: 0, index: 0 };
                const id = (active.index ?? active.id ?? active.name ?? active.order ?? 0).toString();
                return { id, name: active.name || "Sheet1", order: active.order ?? 0, index: active.index ?? 0 };
            } catch (_) {
                return { id: "0", name: "Sheet1", order: 0, index: 0 };
            }
        }

        // đọc cell object hiện tại từ luckysheetfile (cứu trường hợp hook thiếu newCell)
        function getCellObjectByOrder(order, r0, c0) {
            try {
                if (!luckysheet.getluckysheetfile) return null;
                const files = luckysheet.getluckysheetfile();
                if (!files || !files.length) return null;

                const sh = files.find((f) => Number(f.order ?? 0) === Number(order));
                const data = sh && sh.data ? sh.data : null;
                if (!data) return null;
                const row = data[r0];
                if (!row) return null;
                return row[c0] ?? null;
            } catch (_) {
                return null;
            }
        }

        function recordCellChange(r, c, oldCell, newCell) {
            const sheet = getActiveSheetMeta();
            const r0 = Number(r);
            const c0 = Number(c);
            if (Number.isNaN(r0) || Number.isNaN(c0)) return;

            // nếu newCell null → đọc cell hiện tại từ file
            const realNew = newCell ?? getCellObjectByOrder(sheet.order, r0, c0);

            const oldN = normalizeCell(oldCell);
            const newN = normalizeCell(realNew);

            const key = `${sheet.id}#${r0}#${c0}`;
            const now = Date.now();

            if (!__changes[key]) {
                __changes[key] = {
                    sheetId: sheet.id,
                    sheetName: sheet.name,
                    sheetOrder: sheet.order,
                    sheetIndex: sheet.index,
                    r: r0,
                    c: c0,
                    a1: a1Address(r0, c0),
                    old: oldN,
                    new: newN,
                    firstTs: now,
                    lastTs: now,
                    count: 1,
                };
            } else {
                __changes[key].sheetName = sheet.name; // rename sheet thì update name luôn
                __changes[key].sheetOrder = sheet.order;
                __changes[key].new = newN;
                __changes[key].lastTs = now;
                __changes[key].count += 1;
            }

            const total = Object.keys(__changes).length;
            setChangeCount(total);

            postToFlutter({ type: "cell_change", change: __changes[key], total });
        }

        function commitEditIfNeeded() {
            try {
                if (luckysheet.exitEditMode) luckysheet.exitEditMode();
            } catch (_) { }
        }

        window.exportChangesToFlutter = function () {
            commitEditIfNeeded();
            const list = Object.values(__changes);
            postToFlutter({ type: "export_changes", total: list.length, changes: list });
        };

        window.clearChanges = function () {
            for (const k in __changes) delete __changes[k];
            setChangeCount(0);
            postToFlutter({ type: "changes_cleared" });
        };

        // ===== Sheet watcher (add/rename/delete/reorder) =====
        let __sheetWatchTimer = null;
        let __sheetSnapshot = []; // [{id,name,order}]
        let __sheetOpsTotal = 0;

        function getSheetsMeta() {
            const all = luckysheet.getAllSheets ? luckysheet.getAllSheets() : [];
            const meta = all.map(s => {
                const id = (s.index ?? s.id ?? s.name ?? s.order ?? 0).toString();
                return {
                    id,
                    name: (s.name ?? "Sheet").toString(),
                    order: Number(s.order ?? 0),
                };
            }).sort((a, b) => a.order - b.order);
            return meta;
        }

        function diffSheets(prev, next) {
            const ops = [];
            const prevMap = new Map(prev.map(s => [s.id, s]));
            const nextMap = new Map(next.map(s => [s.id, s]));

            for (const n of next) {
                if (!prevMap.has(n.id)) ops.push({ op: "sheet_added", sheet: n });
            }
            for (const p of prev) {
                if (!nextMap.has(p.id)) ops.push({ op: "sheet_deleted", sheet: p });
            }
            for (const n of next) {
                const p = prevMap.get(n.id);
                if (!p) continue;
                if (p.name !== n.name) ops.push({ op: "sheet_renamed", from: p.name, to: n.name, sheet: n });
                if (Number(p.order) !== Number(n.order)) ops.push({ op: "sheet_reordered", from: p.order, to: n.order, sheet: n });
            }
            return ops;
        }

        function startSheetWatcher() {
            try {
                const cur = getSheetsMeta();
                // nếu timer đã có → chỉ refresh snapshot (tránh tạo nhiều interval)
                if (__sheetWatchTimer) {
                    __sheetSnapshot = cur;
                    return;
                }

                __sheetSnapshot = cur;
                __sheetWatchTimer = setInterval(() => {
                    try {
                        const nowMeta = getSheetsMeta();
                        const ops = diffSheets(__sheetSnapshot, nowMeta);
                        if (ops.length) {
                            __sheetSnapshot = nowMeta;
                            __sheetOpsTotal += ops.length;
                            setSheetOpsCount(__sheetOpsTotal);

                            postToFlutter({
                                type: "sheet_ops",
                                ts: Date.now(),
                                ops,
                                sheets: nowMeta,
                            });
                        }
                    } catch (_) { }
                }, 400);
            } catch (_) { }
        }

        function createWithHooks(options) {
            options.hook = options.hook || {};

            options.hook.cellUpdated = function () {
                const args = Array.from(arguments);
                const r = args[0];
                const c = args[1];
                const oldCell = args.length >= 3 ? args[2] : null;
                const newCell = args.length >= 4 ? args[3] : null;
                recordCellChange(r, c, oldCell, newCell);
            };

            options.hook.sheetActivate = function () {
                const s = getActiveSheetMeta();
                postToFlutter({ type: "sheet_activate", sheet: s });
            };

            luckysheet.create(options);
            startSheetWatcher(); // IMPORTANT
        }

        function initBlank() {
            createWithHooks({
                container: "luckysheet",
                title: "POC",
                lang: "en",
                data: [{ name: "Sheet1", index: 0, status: 1, order: 0, celldata: [] }],
            });
            postToFlutter({ type: "web_ready" });
        }

        // ===== Import XLSX =====
        window.importXlsxBase64 = function (b64, filename) {
            try {
                const binary = atob(b64);
                const len = binary.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);

                const blob = new Blob([bytes], {
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                });

                const file = new File([blob], filename || "import.xlsx");

                LuckyExcel.transformExcelToLucky(
                    file,
                    function (exportJson) {
                        try { luckysheet.destroy(); } catch (e) { }

                        createWithHooks({
                            container: "luckysheet",
                            data: exportJson.sheets,
                            title: exportJson.info && exportJson.info.name ? exportJson.info.name : "Imported",
                        });

                        postToFlutter({ type: "import_ok", sheetCount: exportJson.sheets.length });
                    },
                    function (err) {
                        postToFlutter({ type: "import_err", err: String(err) });
                    }
                );
            } catch (e) {
                postToFlutter({ type: "import_err", err: String(e) });
            }
        };

        initBlank();
    </script>

</body>

</html>